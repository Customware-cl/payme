# Diagrama de Flujo - Carga de AplicaciÃ³n Web desde WhatsApp

## Diagrama General del Flujo Completo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    USUARIO HACE CLICK EN LINK WHATSAPP                       â”‚
â”‚  https://somospayme.cl/menu?token=menu_[tenant]_[contact]_[timestamp]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚   Navegador carga HTML      â”‚
                     â”‚  /public/menu/index.html    â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚  Script carga app.js        â”‚
                     â”‚  DOMContentLoaded event     â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚ init() extrae token de URL  â”‚
                     â”‚  state.token = urlParams    â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚  validateSession()          â”‚
                     â”‚  GET /menu-data?token=...   â”‚
                     â”‚  &type=user                 â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                                        â”‚
         Â¿Token vÃ¡lido?                            Â¿Token vÃ¡lido?
                â”‚ SÃ                                     â”‚ NO
                â–¼                                        â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Parsear token en BD     â”‚        â”‚  showExpiredScreen()     â”‚
     â”‚ Verificar expiraciÃ³n    â”‚        â”‚  Mostrar mensaje error   â”‚
     â”‚ Actualizar last_used_at â”‚        â”‚  y salir                 â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  loadUserName()         â”‚
     â”‚  GET /menu-data?        â”‚
     â”‚  token=...&type=user    â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Detectar onboarding requerido    â”‚
     â”‚ Â¿Tiene tenant propio?            â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                    â”‚
    SÃ (requiere)         NO (completo)
          â”‚                    â”‚
          â–¼                    â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ showOnboarding   â”‚  â”‚ setupEvent       â”‚
  â”‚ Screen()         â”‚  â”‚ Listeners()      â”‚
  â”‚                  â”‚  â”‚ Mostrar menÃº     â”‚
  â”‚ Mostrar          â”‚  â”‚ principal        â”‚
  â”‚ formulario       â”‚  â”‚                  â”‚
  â”‚ (nombre,         â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  apellido,       â”‚  â”‚ â”‚ Ver Perfil  â”‚  â”‚
  â”‚  email)          â”‚  â”‚ â”‚ Datos banco  â”‚  â”‚
  â”‚                  â”‚  â”‚ â”‚ Nuevo loan  â”‚  â”‚
  â”‚ Actualizar       â”‚  â”‚ â”‚ Est. loans  â”‚  â”‚
  â”‚ saludo           â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  handleOnboarding    â”‚
  â”‚  Submit()            â”‚
  â”‚                      â”‚
  â”‚  POST /complete-     â”‚
  â”‚  onboarding          â”‚
  â”‚  { token,            â”‚
  â”‚    first_name,       â”‚
  â”‚    last_name,        â”‚
  â”‚    email }           â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Edge Function        â”‚
  â”‚ complete-onboarding  â”‚
  â”‚                      â”‚
  â”‚ 1. Obtener tenant_c  â”‚
  â”‚ 2. Verificar tenant  â”‚
  â”‚ 3. Actualizar prof   â”‚
  â”‚ 4. Crear tenant      â”‚
  â”‚ 5. Registrar evento  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ window.location.     â”‚
  â”‚ reload()             â”‚
  â”‚ Reinicia menÃº        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Diagrama del Flujo de PrÃ©stamo (Loan Form)

```
                  USUARIO CLICK "NUEVO PRÃ‰STAMO"
                            â”‚
                            â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ handleNewLoanClick()         â”‚
                â”‚ Redirige a:                  â”‚
                â”‚ /loan-form?token=[TOKEN]     â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Carga app.js del formulario  â”‚
                â”‚ init() ejecuta               â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ validateSession()            â”‚
                â”‚ GET /loan-web-form?token=... â”‚
                â”‚ Obtiene contactos del tenant â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                       â”‚
          Â¿Token vÃ¡lido?           Â¿Token vÃ¡lido?
                â”‚ SÃ                    â”‚ NO
                â–¼                       â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ renderContacts() â”‚    â”‚ showExpiredScreenâ”‚
     â”‚ Listar contactos â”‚    â”‚ Mostrar error    â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  setupEventListeners()           â”‚
     â”‚  Configurar navegaciÃ³n entre     â”‚
     â”‚  pantallas del formulario        â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ PANTALLA 0: Â¿Direction?          â”‚
     â”‚                                  â”‚
     â”‚  ğŸ”˜ Yo prestÃ©                    â”‚
     â”‚  ğŸ”˜ Me prestaron                 â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”œâ”€ "Yo prestÃ©" â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                        â–¼
                â”‚              state.loanDirection = 'lent'
                â”‚              updateTexts() - actualiza labels
                â”‚
                â”œâ”€ "Me prestaron" â”€â”€â”€â”€â”€â”€â”
                â”‚                        â–¼
                â”‚              state.loanDirection = 'borrowed'
                â”‚              updateTexts() - actualiza labels
                â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ PANTALLA 1: Â¿QuiÃ©n?  â”‚
                            â”‚                      â”‚
                            â”‚ [Juan PÃ©rez]         â”‚
                            â”‚ [Carlos LÃ³pez]       â”‚
                            â”‚ [â• Nuevo contacto]  â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                                           â”‚
         Click en contacto                    Click "â• Nuevo"
                â”‚                                   â”‚
                â–¼                                   â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Guardar datos:   â”‚             â”‚ Modal nuevo contacto â”‚
     â”‚ contactId        â”‚             â”‚ - Nombre completo    â”‚
     â”‚ contactName      â”‚             â”‚ - TelÃ©fono (opt)     â”‚
     â”‚ contactPhone     â”‚             â”‚ - Guardar            â”‚
     â”‚ newContact=false â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
                â”‚                               â”‚ Enviar
                â”‚                               â–¼
                â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                    â”‚ Guardar datos:       â”‚
                â”‚                    â”‚ contactName = nombre â”‚
                â”‚                    â”‚ contactPhone = phone â”‚
                â”‚                    â”‚ newContact = true    â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ PANTALLA 2: Â¿QuÃ©?            â”‚
                â”‚                              â”‚
                â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                â”‚  â”‚   ğŸ’°  Dinero            â”‚ â”‚
                â”‚  â”‚  Monto: [$50000]        â”‚ â”‚
                â”‚  â”‚  Concepto: [almuerzo]   â”‚ â”‚
                â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                â”‚                              â”‚
                â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                â”‚  â”‚  ğŸ“¦  Objeto             â”‚ â”‚
                â”‚  â”‚  DescripciÃ³n: [bici]    â”‚ â”‚
                â”‚  â”‚  Imagen: [opcional]     â”‚ â”‚
                â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                         â”‚
            "Dinero"                   "Objeto"
                â”‚                         â”‚
                â–¼                         â–¼
         state.loanType='money'   state.loanType='object'
         Validar monto > 0        Validar desc >= 3 chars
         Mostrar concepto         Sin concepto
                â”‚                         â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ PANTALLA 3: Â¿CuÃ¡ndo?         â”‚
                â”‚                              â”‚
                â”‚  ğŸ• MaÃ±ana                   â”‚
                â”‚  ğŸ“… En una semana            â”‚
                â”‚  ğŸ“† A fin de mes             â”‚
                â”‚  ğŸ—“ï¸ Fecha especÃ­fica         â”‚
                â”‚     [calendario]             â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Calcular fecha               â”‚
                â”‚ calculateDate(option)        â”‚
                â”‚ Guardar en formData          â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ PANTALLA 4: Confirmar        â”‚
                â”‚                              â”‚
                â”‚  Para: Juan PÃ©rez            â”‚
                â”‚  PrÃ©stamo: $50000            â”‚
                â”‚  Concepto: almuerzo          â”‚
                â”‚  DevoluciÃ³n: 25 Oct 2024     â”‚
                â”‚                              â”‚
                â”‚  [Crear prÃ©stamo]            â”‚
                â”‚  [Editar]                    â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ createLoan()                 â”‚
                â”‚                              â”‚
                â”‚ showLoader(true)             â”‚
                â”‚ Preparar payload segÃºn       â”‚
                â”‚ direcciÃ³n (lent/borrowed)    â”‚
                â”‚                              â”‚
                â”‚ POST /loan-web-form          â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Edge Function:               â”‚
                â”‚ loan-web-form                â”‚
                â”‚                              â”‚
                â”‚ 1. Parsear token            â”‚
                â”‚ 2. Validar datos            â”‚
                â”‚ 3. Preparar contexto        â”‚
                â”‚ 4. Llamar FlowHandler       â”‚
                â”‚ 5. Crear agreement          â”‚
                â”‚ 6. Registrar evento         â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                         â”‚
    Â¿Hay imagen?                            Â¿Hay imagen?
         â”‚ SÃ                                   â”‚ NO
         â–¼                                       â–¼
    uploadImageToStorage()          Saltarse subida
         â”‚                           de imagen
         â”‚                                   â”‚
         â–¼                                   â”‚
    PATCH /loan-web-form             â”‚
    Actualizar metadata                 â”‚
         â”‚                                   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ PANTALLA 5: Ã‰xito   â”‚
          â”‚                     â”‚
          â”‚     âœ“               â”‚
          â”‚ Â¡PrÃ©stamo creado!   â”‚
          â”‚                     â”‚
          â”‚ [Crear otro]        â”‚
          â”‚ [Volver al menÃº]    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                     â”‚
    "Crear otro"      "Volver al menÃº"
         â”‚                     â”‚
         â–¼                     â–¼
    Reset form         /menu?token=[TOKEN]
    Volver a        Redireccionar a menÃº
    pantalla 0      principal
```

---

## Diagrama de Token Parsing - menu-data

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ parseToken(token, supabase) â†’ menu-data/index.ts lÃ­nea 14   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ token.split('_')   â”‚
                â”‚ Analizar estructuraâ”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                             â”‚
    Â¿Formato "llt"?              Â¿Formato "short"?
          â”‚ SÃ                         â”‚ SÃ
          â–¼                            â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ LLT FORMAT:          â”‚  â”‚ SHORT FORMAT:        â”‚
  â”‚ menu_llt_[T]_[C]_[U]_[TS]  â”‚ menu_[T]_[C]_[TS]        â”‚
  â”‚                      â”‚  â”‚                      â”‚
  â”‚ Validaciones:        â”‚  â”‚ Validaciones:        â”‚
  â”‚ 1. 6 parts           â”‚  â”‚ 1. 4 parts           â”‚
  â”‚ 2. Buscar en DB      â”‚  â”‚ 2. Calcular edad     â”‚
  â”‚    active_sessions   â”‚  â”‚    Age = now - TS    â”‚
  â”‚ 3. Verificar         â”‚  â”‚ 3. Si > 1 hora       â”‚
  â”‚    revoked=false     â”‚  â”‚    â†’ return null     â”‚
  â”‚ 4. Verificar exp     â”‚  â”‚ 4. Return data       â”‚
  â”‚    expires_at        â”‚  â”‚                      â”‚
  â”‚ 5. Update            â”‚  â”‚                      â”‚
  â”‚    last_used_at      â”‚  â”‚                      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                            â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ return {                   â”‚
        â”‚   tenant_id,               â”‚
        â”‚   contact_id,              â”‚
        â”‚   timestamp,               â”‚
        â”‚   token_type               â”‚
        â”‚ }                          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Diagrama de Estado Global - Formulario de PrÃ©stamo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STATE OBJECT - loan-form/app.js lÃ­neas 1-19                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

const state = {
    â”Œâ”€ token (string | null)
    â”‚   URL param token extraÃ­do
    â”‚   Usado en todas las llamadas API
    â”‚
    â”œâ”€ contacts (array)
    â”‚   Contactos del tenant
    â”‚   Cargados desde GET /loan-web-form?token=...
    â”‚   Estructura: { id, name, phone }
    â”‚
    â”œâ”€ loanDirection (string | null)
    â”‚   'lent' = Yo prestÃ©
    â”‚   'borrowed' = Me prestaron
    â”‚   Usado para:
    â”‚     - updateTexts() cambiar labels
    â”‚     - determinar endpoint POST
    â”‚
    â””â”€ formData (object)
        â”œâ”€ contactId (string | null)
        â”‚  ID del contacto en tenant
        â”‚  null si new_contact=true
        â”‚
        â”œâ”€ contactName (string | null)
        â”‚  Nombre completo del contacto
        â”‚  Visible en resumen y Ã©xito
        â”‚
        â”œâ”€ contactPhone (string | null)
        â”‚  TelÃ©fono del contacto
        â”‚  Formato: +56912345678
        â”‚
        â”œâ”€ newContact (boolean)
        â”‚  true = Contacto creado en formulario
        â”‚  false = Contacto existente
        â”‚
        â”œâ”€ loanType (string | null)
        â”‚  'money' = PrÃ©stamo en efectivo
        â”‚  'object' = PrÃ©stamo de objeto
        â”‚  Determina validaciones y campos
        â”‚
        â”œâ”€ loanDetail (string | null)
        â”‚  Si loanType='money': monto (ej: "50000")
        â”‚  Si loanType='object': descripciÃ³n (ej: "bici")
        â”‚
        â”œâ”€ loanConcept (string | null)
        â”‚  Solo para money
        â”‚  Concepto del prÃ©stamo (ej: "almuerzo")
        â”‚  Puede ser null
        â”‚
        â”œâ”€ dateOption (string | null)
        â”‚  'tomorrow' | 'week' | 'month-end' | 'custom'
        â”‚
        â”œâ”€ customDate (string | null)
        â”‚  Formato: YYYY-MM-DD
        â”‚  Solo si dateOption='custom'
        â”‚
        â”œâ”€ imageFile (File | null)
        â”‚  Archivo seleccionado del input file
        â”‚
        â””â”€ imageUrl (string | null)
           URL pÃºblica de imagen en Supabase Storage
           Retornada despuÃ©s de uploadImageToStorage()
```

---

## Flujo de ValidaciÃ³n de Datos

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VALIDACIONES EN FRONTEND - loan-form/app.js               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

MONTO (tipo 'money'):
  Input event listener (lÃ­nea 478)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 1. Extract nÃºmeros: [^\d]/g      â”‚
  â”‚ 2. Si vacÃ­o:                     â”‚
  â”‚    - Ocultar botÃ³n Continuar     â”‚
  â”‚ 3. Si hay dÃ­gitos:               â”‚
  â”‚    - parseInt() â†’ numericValue   â”‚
  â”‚    - Validar > 0                 â”‚
  â”‚    - Formatear con separadores   â”‚
  â”‚    - Mostrar botÃ³n Continuar     â”‚
  â”‚    - Guardar raw en formData     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

DESCRIPCIÃ“N (tipo 'object'):
  Input event listener (lÃ­nea 478)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 1. trim()                        â”‚
  â”‚ 2. Validar >= 3 caracteres       â”‚
  â”‚ 3. Si vÃ¡lido:                    â”‚
  â”‚    - Mostrar botÃ³n Continuar     â”‚
  â”‚    - Guardar en formData         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CONCEPTO (opcional para 'money'):
  Input change listener (lÃ­nea 518)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 1. Obtener valor                 â”‚
  â”‚ 2. trim()                        â”‚
  â”‚ 3. Si vacÃ­o:                     â”‚
  â”‚    - formData.loanConcept = null â”‚
  â”‚ 4. Si tiene valor:               â”‚
  â”‚    - Guardar en formData         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

FECHA:
  Date chip click (lÃ­nea 532)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 1. Si 'custom':                  â”‚
  â”‚    - Mostrar input date          â”‚
  â”‚    - Ocultar botÃ³n Continuar     â”‚
  â”‚    - Focus en input              â”‚
  â”‚ 2. Si otra opciÃ³n:               â”‚
  â”‚    - Ocultar custom date input   â”‚
  â”‚    - Mostrar botÃ³n Continuar     â”‚
  â”‚                                  â”‚
  â”‚ Change event en custom date:     â”‚
  â”‚    - Guardar en formData         â”‚
  â”‚    - Mostrar botÃ³n Continuar     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TELÃ‰FONO (frontend validation):
  validatePhone() funciÃ³n (lÃ­nea 160)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 1. Si vacÃ­o:                     â”‚
  â”‚    - return true (opcional)      â”‚
  â”‚ 2. Limpiar caracteres especiales â”‚
  â”‚ 3. Regex: /^\+?56\d{9}$/        â”‚
  â”‚    Formato: +56912345678         â”‚
  â”‚ 4. Si vÃ¡lido: true               â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

EMAIL (frontend validation):
  handleOnboardingSubmit() (lÃ­nea 152)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Regex: /^[^\s@]+@[^\s@]+\.[^\s@]+$/ â”‚
  â”‚ Ejemplos vÃ¡lidos:                â”‚
  â”‚   - user@example.com             â”‚
  â”‚   - test.email@domain.co         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

NOMBRES (frontend validation):
  handleOnboardingSubmit() (lÃ­nea 159)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Regex: /^[a-zA-ZÃ¡Ã©Ã­Ã³ÃºÃÃ‰ÃÃ“ÃšÃ±Ã‘\s]+$ â”‚
  â”‚ - Solo letras y espacios         â”‚
  â”‚ - Soporta acentos               â”‚
  â”‚ - Soporta Ã±/Ã‘                   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Diagrama de CORS y Headers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CORS HEADERS - Todos los endpoints Edge Functions           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  â”Œâ”€ Permite requests desde cualquier dominio
  â”‚
  'Access-Control-Allow-Headers': 
    'authorization, x-client-info, apikey, content-type',
  â”Œâ”€ Headers permitidas en requests
  â”‚
  'Access-Control-Allow-Methods': 'POST, GET, PATCH, OPTIONS'
  â”Œâ”€ MÃ©todos HTTP permitidos
  â”‚
}

OPTIONS request (CORS preflight):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Browser envÃ­a automÃ¡ticamente antes    â”‚
â”‚ de PUT, PATCH, DELETE requests         â”‚
â”‚                                        â”‚
â”‚ Server responde con:                   â”‚
â”‚   status: 200                          â”‚
â”‚   headers: corsHeaders                 â”‚
â”‚   body: 'ok'                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

